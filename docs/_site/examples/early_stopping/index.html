<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Benefit to Early Stopping | AME Lab</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Benefit to Early Stopping" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Early Stopping and Treatment Effect Estimates Both the FLAME and DAME algorithms begin by matching identical twins (“exact matches”) in the dataset. As iterations of the algorithm progress, later matched units are likely to have the highest error in estimated treatment effects. For this reason, there are situations where a user may wish to stop the FLAME or DAME algorithm in order to avoid poor quality matches, and if its not critical that all units are matched." /> <meta property="og:description" content="Early Stopping and Treatment Effect Estimates Both the FLAME and DAME algorithms begin by matching identical twins (“exact matches”) in the dataset. As iterations of the algorithm progress, later matched units are likely to have the highest error in estimated treatment effects. For this reason, there are situations where a user may wish to stop the FLAME or DAME algorithm in order to avoid poor quality matches, and if its not critical that all units are matched." /> <link rel="canonical" href="http://localhost:4000/examples/early_stopping/" /> <meta property="og:url" content="http://localhost:4000/examples/early_stopping/" /> <meta property="og:site_name" content="AME Lab" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-10-28T18:18:10-05:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"http://localhost:4000/examples/early_stopping/","datePublished":"2020-10-28T18:18:10-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/examples/early_stopping/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/content/logos/logo.svg"}},"headline":"Benefit to Early Stopping","description":"Early Stopping and Treatment Effect Estimates Both the FLAME and DAME algorithms begin by matching identical twins (“exact matches”) in the dataset. As iterations of the algorithm progress, later matched units are likely to have the highest error in estimated treatment effects. For this reason, there are situations where a user may wish to stop the FLAME or DAME algorithm in order to avoid poor quality matches, and if its not critical that all units are matched.","dateModified":"2020-10-28T18:18:10-05:00","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <div class="nav-category">DAME-FLAME Python Package</div> <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="http://localhost:4000/getting-started" class="nav-list-link">Getting Started</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/documentation" class="nav-list-link">Documentation</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/documentation/user-guide/" class="nav-list-link">User Guide</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/documentation/user-guide/Introduction" class="nav-list-link">Introduction to Causal Inference</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/user-guide/to-match-or-not" class="nav-list-link">Whether to use Matching</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/user-guide/data-requirements" class="nav-list-link">Data Requirements for DAME-FLAME</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/user-guide/Getting-Matches" class="nav-list-link">Getting Matches</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/user-guide/Treatment-Effects" class="nav-list-link">Treatment Effect Estimates</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/user-guide/Algorithm-Controls" class="nav-list-link">Algorithm Controls</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/user-guide/Missing-Data" class="nav-list-link">Missing Data Handling</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/documentation/api-documentation/" class="nav-list-link">API Documentation</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/documentation/api-documentation/DAME" class="nav-list-link">DAME</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/api-documentation/FLAME" class="nav-list-link">FLAME</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/documentation/api-documentation/post-processing" class="nav-list-link">Post Processing</a> </li></ul></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/examples" class="nav-list-link">Examples</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/examples/flame_vs_dame_quality/" class="nav-list-link">Comparing DAME and FLAME</a></li><li class="nav-list-item active"><a href="http://localhost:4000/examples/early_stopping/" class="nav-list-link active">Benefit to Early Stopping</a></li><li class="nav-list-item "><a href="http://localhost:4000/examples/interpretability/" class="nav-list-link">Interpreting Covariate Importance</a></li><li class="nav-list-item "><a href="http://localhost:4000/examples/exact_matching/" class="nav-list-link">Exact Matching Only</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/FAQ" class="nav-list-link">FAQ and Vocabulary Guide</a><ul class="nav-list "></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search AME Lab" aria-label="Search AME Lab" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/almost-matching-exactly" class="site-button" target="_blank" rel="noopener noreferrer" > GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/examples">Examples</a></li> <li class="breadcrumb-nav-list-item"><span>Benefit to Early Stopping</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="fs-9" id="early-stopping-and-treatment-effect-estimates"> <a href="#early-stopping-and-treatment-effect-estimates" class="anchor-heading" aria-labelledby="early-stopping-and-treatment-effect-estimates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Early Stopping and Treatment Effect Estimates </h1> <p>Both the FLAME and DAME algorithms begin by matching identical twins (“exact matches”) in the dataset. As iterations of the algorithm progress, later matched units are likely to have the highest error in estimated treatment effects. For this reason, there are situations where a user may wish to stop the FLAME or DAME algorithm in order to avoid poor quality matches, and if its not critical that all units are matched.</p> <p>From this example, we see that if high accuraccy between the estimated treatment effect and true treatment effect is a priority, then this algorithm should be stopped early.</p> <div class="early_stop"> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">dame_flame</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="k">def</span> <span class="nf">draw_scatter</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">mse</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s">'o'</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s">'black'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">wrap</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="o">*</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>    
    <span class="n">ax</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Estimated CATT"</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="n">labelsize</span><span class="o">*</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="s">"MSE: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mse</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">'center'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="o">*</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">'True CATT'</span><span class="p">)</span>

<span class="c1"># Generate Data
</span><span class="n">df</span><span class="p">,</span> <span class="n">true_catt</span> <span class="o">=</span> <span class="n">dame_flame</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">gen_data_binx_decay_importance</span><span class="p">(</span><span class="n">num_control</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_treated</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                    <span class="n">num_cov</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bernoulli_param</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bi_mean</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bi_stdev</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Get Matches using the DAME algorithm
</span><span class="n">model</span> <span class="o">=</span> <span class="n">dame_flame</span><span class="p">.</span><span class="n">matching</span><span class="p">.</span><span class="n">DAME</span><span class="p">(</span><span class="n">repeats</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">holdout_data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">model_stop_early</span> <span class="o">=</span> <span class="n">dame_flame</span><span class="p">.</span><span class="n">matching</span><span class="p">.</span><span class="n">DAME</span><span class="p">(</span><span class="n">repeats</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">early_stop_un_c_frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">model_stop_early</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">holdout_data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">model_stop_early</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Since not all units are matched, filter on those that are when finding CATT
</span><span class="n">estimated_catt_full</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">true_catt_full</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">estimated_catt_early</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">true_catt_early</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">unit</span><span class="p">][</span><span class="s">'treated'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">temp_cate</span> <span class="o">=</span> <span class="n">dame_flame</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">post_processing</span><span class="p">.</span><span class="n">CATE</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_cate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">:</span>
            <span class="n">estimated_catt_full</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_cate</span><span class="p">)</span>
            <span class="n">true_catt_full</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">true_catt</span><span class="p">[</span><span class="n">unit</span><span class="p">])</span>
        <span class="n">temp_cate</span> <span class="o">=</span> <span class="n">dame_flame</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">post_processing</span><span class="p">.</span><span class="n">CATE</span><span class="p">(</span><span class="n">model_stop_early</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_cate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">:</span>
            <span class="n">estimated_catt_early</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_cate</span><span class="p">)</span>
            <span class="n">true_catt_early</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">true_catt</span><span class="p">[</span><span class="n">unit</span><span class="p">])</span>

<span class="c1"># Draw plot
</span><span class="n">draw_scatter</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_catt_early</span><span class="p">,</span> <span class="n">estimated_catt_early</span><span class="p">,</span> <span class="s">"DAME, stopped at 30% control unmatched"</span><span class="p">,</span>  <span class="s">"green"</span><span class="p">,</span> 
             <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">true_catt_early</span><span class="p">,</span> <span class="n">estimated_catt_early</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">draw_scatter</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">true_catt_full</span><span class="p">,</span> <span class="n">estimated_catt_full</span><span class="p">,</span> <span class="s">"DAME, matching all units"</span><span class="p">,</span>  <span class="s">"green"</span><span class="p">,</span> 
             <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">true_catt_full</span><span class="p">,</span> <span class="n">estimated_catt_full</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>

</code></pre></div> </div> </div> <p><img src="https://github.com/nehargupta/dame-flame-experiments/raw/master/early_stopping.png" alt="Two Graphs" title="Early Stopping" /></p> <p><a href="https://github.com/nehargupta/dame-flame-experiments/blob/master/early_stopping.ipynb" class="btn fs-5 mb-4 mb-md-0">Download Example From GitHub</a></p> </div> </div> <div class="search-overlay"></div> </div> </body> </html> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']], processEscapes: true } }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
